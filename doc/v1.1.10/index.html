<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libpaf: Pathfinder Client Library API</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libpaf<span id="projectnumber">&#160;1.1.10</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Pathfinder Client Library API </div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#overview">Overview</a></li>
<li class="level1"><a href="#domains">Service Discovery Domains</a><ul><li class="level2"><a href="#domain_conf">Domain Configuration</a><ul><li class="level3"><a href="#domain_file_format">File Format</a></li>
<li class="level3"><a href="#rescan">Domain File Rescan</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#reconnect">Connection Reestablishment</a></li>
<li class="level1"><a href="#liveness">Liveness Tracking</a></li>
<li class="level1"><a href="#multihoming">DNS and Multihomed Servers</a></li>
<li class="level1"><a href="#ttl">Service TTL</a></li>
<li class="level1"><a href="#tracing">Tracing</a></li>
<li class="level1"><a href="#thread_safety">Multi-thread Safety</a></li>
</ul>
</div>
<div class="textblock"><p>This is the documentation for the Pathfinder Client Library API.</p>
<ul>
<li><a class="el" href="paf_8h.html" title="Core Pathfinder Client Library API.">paf.h</a> Core functionality</li>
<li><a class="el" href="paf__props_8h.html" title="Pathfinder Service Properties API.">paf_props.h</a> Service property access.</li>
<li><a class="el" href="paf__value_8h.html" title="Pathfinder Property Value API.">paf_value.h</a> Property value.</li>
<li><a class="el" href="paf__err_8h_source.html">paf_err.h</a> Error handling.</li>
<li><a class="el" href="paf__match_8h.html" title="Pathfinder Client Library&#39;s Subscription Match-related Data Structure.">paf_match.h</a> Subscription matching.</li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Mattias RÃ¶nnblom </dd></dl>
<dl class="section version"><dt>Version</dt><dd>0.1 [API] </dd>
<dd>
1.1.10 [Implementation]</dd></dl>
<h1><a class="anchor" id="overview"></a>
Overview</h1>
<p>The Pathfinder Client Library API is used to access one or more Pathfinder service discovery domains, either as a service producer or consumer.</p>
<p>All the functions in this API are non-blocking in the sense that no blocking system calls are made.</p>
<p>For a description of the Pathfinder data model, refer to the <a href="https://github.com/Ericsson/paf/blob/master/doc/PROTOCOLv3.md">Pathfinder Protocol Specification</a>. Note: there are important semantical differences between certain operations on the protocol level, compared to this API (e.g., <a class="el" href="paf_8h.html#a0882224e814007bc8d60aa951e432df6">paf_publish()</a> doesn't have the exact same semantics as the <code>publish</code> protocol-level command).</p>
<h1><a class="anchor" id="domains"></a>
Service Discovery Domains</h1>
<p>A Pathfinder service discovery domain is a namespace shared by all Pathfinder clients attached to that domain. A service publish by one client can be seen by all other clients attached to that domain. A domain is served by one or more Pathfinder server instances.</p>
<p>In order to participate in a domain, an application issues <a class="el" href="paf_8h.html#a52fec2c02be95b483132e4637d73a590">paf_attach()</a> with the appropriate service discovery domain name. It need not know what servers are currently serving that domain.</p>
<h2><a class="anchor" id="domain_conf"></a>
Domain Configuration</h2>
<p>The mapping between a service discovery domain name and the set of addresses to the Pathfinder servers serving this domain is kept in a file. The configuration for a particular domain name must be stored in a file with the same name as the domain, and be located in the domain files directory. The compile-time default location is is <code>/run/paf/domains</code>.d/.</p>
<p>The directory may contain an arbitrary number of domains.</p>
<p>In case the domain file does not exist at the time of the <a class="el" href="paf_8h.html#a52fec2c02be95b483132e4637d73a590">paf_attach()</a> call, <code>libpaf</code> will periodically check if it has been created.</p>
<p>In case the file is modified (e.g., a server is added, removed or has its address changed), the file will be re-read by <code>libpaf</code>. If the file is removed, the set of servers is considered empty.</p>
<p>The environment variable <code>PAF_DOMAINS</code> may set in case a non-standard directory is preferred over the default.</p>
<h3><a class="anchor" id="domain_file_format"></a>
File Format</h3>
<p><code>libpaf</code> supports two file formats. Either the contents of the file is a newline-separated list of XCM addresses, or a JSON object.</p>
<p>The newline-separated format allows for comments. In this format, empty lines and lines beginning with '#' are ignored. JSON does not support comments.</p>
<p>A domain file in the JSON format must contain a root JSON object, with a key "servers". The value of "servers" must be an array of zero or more JSON objects, each representing a server.</p>
<p>The server object must have a key "address", with the server's address in XCM format as its value.</p>
<p>A server object may have a key "localAddress", in which case this XCM-formatted address will be bound to before establishing an outgoing connection.</p>
<p>A server object may have a key "minProtocolVersion", used to increase the minimum protocol version advertised as supported by <code>libpaf</code> to that server. If "minProtocolVersion" is set higher than the maximum version suported by <code>libpaf</code> (i.e., &gt; 3), no connections will be initiated to that server.</p>
<p>A server object may have the key "maxProtocolVersion", used to decrease the maximum protocol version advertised by <code>libpaf</code>. If the "maxProtocolVersion" is set lower than the minimum version supported by <code>libpaf</code> (i.e., &lt; 2), no connections will be initiated to that server.</p>
<p>If both "minProtocolVersion" and "maxProtocolVersion" are set, "minProtocolVersion" must be equal to or lower than "maxProtocolVersion".</p>
<p>A server object may have a keys "minIdleTime" or "maxIdleTime" to configure client-side <a class="el" href="index.html#liveness">Liveness Tracking</a>, and override the <code>PAF_IDLE_MIN</code> and <code>PAF_IDLE_MAX</code> values and the compile-time defaults (in case the environment variables are not set).</p>
<p>If both "minIdleTime" and "maxIdleTime" are set, "minIdleTime" must be equal to or lower than "maxIdleTime".</p>
<p>A server object may include a key "networkNamespace". If present, the library will make sure the outoing transport layer connection originates from a Linux network namespace named per the key's value. To switch between network namespaces, the process needs the <code>CAP_SYS_ADMIN</code> capability. The network namespace needs to be named as per iproute2 conventions.</p>
<p>In case the transport protocol uses TLS, a number of optional keys may be present in the server object:</p>
<ul>
<li>"tlsCertificateFile": the leaf certificate to use.</li>
<li>"tlsKeyFile": the private key corresponding to the leaf certificate.</li>
<li>"tlsTrustedCaFile": a file containing the trusted CA certificates.</li>
<li>"tlsCrlFile": a file containing Certificate Revocation Lists (CRLs).</li>
</ul>
<p>Setting tlsCrlFile will enable certificate revocation verification, and requires <code>libpaf</code> to be linked to <code>libxcm</code> version v1.9.0 or later.</p>
<p>In case some/all of the certificate file related keys are left out, <code>libpaf</code> will fall back to using the XCM defaults.</p>
<p>Below is an example of a domain file in JSON format: </p><div class="fragment"><div class="line">{</div>
<div class="line">  <span class="stringliteral">&quot;servers&quot;</span>: [</div>
<div class="line">    {</div>
<div class="line">      <span class="stringliteral">&quot;address&quot;</span>: <span class="stringliteral">&quot;tls:1.2.3.4:4444&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;tlsCertificateFile&quot;</span>: <span class="stringliteral">&quot;/etc/paf/certs/cert.pem&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;tlsKeyFile&quot;</span>: <span class="stringliteral">&quot;/etc/paf/certs/key.pem&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;tlsTrustedCaFile&quot;</span>: <span class="stringliteral">&quot;/etc/paf/certs/ca-bundle.pem&quot;</span></div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      <span class="stringliteral">&quot;address&quot;</span>: <span class="stringliteral">&quot;tls:5.6.7.8:8888&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;minProtocolVersion&quot;</span>: 3,</div>
<div class="line">      <span class="stringliteral">&quot;localAddress&quot;</span>: <span class="stringliteral">&quot;tls:9.9.9.9:0&quot;</span></div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      <span class="stringliteral">&quot;address&quot;</span>: <span class="stringliteral">&quot;tcp:fqdn:1111&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;networkNamespace&quot;</span>: <span class="stringliteral">&quot;oam&quot;</span>,</div>
<div class="line">      <span class="stringliteral">&quot;minIdleTime&quot;</span>: 10</div>
<div class="line">    },</div>
<div class="line">    {</div>
<div class="line">      <span class="stringliteral">&quot;address&quot;</span>: <span class="stringliteral">&quot;ux:foo&quot;</span></div>
<div class="line">      <span class="stringliteral">&quot;maxProtocolVersion&quot;</span>: 2,</div>
<div class="line">    }</div>
<div class="line">  ]</div>
<div class="line">}</div>
</div><!-- fragment --><p>The same configuration (minus the network namespace and the certificate-related configuration), but in the newline-separated format: </p><div class="fragment"><div class="line">tls:1.2.3.4:4444</div>
<div class="line">tls:5.6.7.8:8888</div>
<div class="line">tcp:fqdn:1111</div>
<div class="line">ux:foo</div>
</div><!-- fragment --><h3><a class="anchor" id="rescan"></a>
Domain File Rescan</h3>
<p>For all domains the application currently has attached to, <code>libpaf</code> tracks domain file changes. This check is performed periodically every ~5 s. A small random component is added to avoid load spikes, in case there are many clients on the same system.</p>
<p>This default interval may be changed by setting the <code>PAF_RESCAN</code> environment variable. The value a floating point number (in s). If set to zero, the rescanning is disabled.</p>
<h1><a class="anchor" id="reconnect"></a>
Connection Reestablishment</h1>
<p>In case the connection to a server is lost, or never was successfully established in the first place, <code>libpaf</code> will perform another attempt at a later time.</p>
<p><code>libpaf</code> uses exponential back-off. The first retry is scheduled to occur after 10 ms. Every failed attempt double the retry interval, up to a maximum of 5 s. These two defaults may be changed by setting the <code>PAF_RECONNECT_MIN</code> and/or <code>PAF_RECONNECT_MAX</code> environment variables.</p>
<h1><a class="anchor" id="liveness"></a>
Liveness Tracking</h1>
<p>On connections where the Pathfinder protocol version 3 is negotiated to be used, <code>libpaf</code> performs server liveness tracking on the level of the Pathfinder protocol.</p>
<p>On v3 connections, <code>libpaf</code> imposes an upper limit on how long time the remote peer is allowed to remain idle. When maximum idle time is approaching, libpaf will query the server to ensure it is still alive. In case the server also employs liveness checking, any server queries will be treated as a sign of life, and make libpaf post-poned any liveness query.</p>
<p>The maximum idle time is 30 seconds by default, and may be overriden by setting the <code>PAF_IDLE_MAX</code> environment variable.</p>
<p>The actual max idle time used may be lower than <code>PAF_IDLE_MAX</code>, in case low-TTL services have been published by the application, or have been matched in one of its subscriptions.</p>
<p>The actual max idle time will never be set to lower than <code>PAF_IDLE_MIN</code>, which is 4 seconds by default. To protect the server, <code>libpaf</code> will treat <code>PAF_IDLE_MIN</code> set lower than 1 second as set to 1 second.</p>
<p>On version 2 connections, libpaf depends on the transport protocol (e.g., TCP) for liveness checking.</p>
<p>On version 3 connections, TCP keepalive is disabled.</p>
<p>The minimum idle time is also used as an upper bound for the total amount of time the initial transport connection establishment (e.g., TCP three-way handshake and TLS hello) and the Pathfinder protocol-level hello transaction is allowed to take.</p>
<h1><a class="anchor" id="multihoming"></a>
DNS and Multihomed Servers</h1>
<p>The host part of the XCM server address in the <a class="el" href="index.html#domain_conf">Domain Configuration</a> may either be a DNS hostname or an IP address in string format. If a Pathfinder server DNS hostname resolves to multiple A or AAAA records, <code>libpaf</code> will interpret that as a single, multihomed, server.</p>
<p>In such a scenario, <code>libpaf</code> will attempt to establish a TCP connection the server via all available IP addresses, but will employ only at most one connection for the actual Pathfinder protocol signaling. The Happy Eyeballs (RFC 6555) method is used.</p>
<p>Multihomed servers are only supported when <code>libpaf</code> is running linked to XCM v1.9.0 (or later). For older XCM versions, only the first (i.e., most preferred) IP address will be considered.</p>
<h1><a class="anchor" id="ttl"></a>
Service TTL</h1>
<p>A service published using <code>libpaf</code> has a time-to-live (TTL) of 30 s. This default may be changed by setting the <code>PAF_TTL</code> environment variable, before the <a class="el" href="paf_8h.html#a0882224e814007bc8d60aa951e432df6">paf_publish()</a> call.</p>
<p>The <a class="el" href="paf_8h.html#ac5a34f3d8c4ed24ff39b06015a128cd6">paf_set_ttl()</a> function may be used to update the TTL for a specific service.</p>
<p>For a description of how service TTLs work in Pathfinder, please refer to the Pathfinder protocol specification.</p>
<h1><a class="anchor" id="tracing"></a>
Tracing</h1>
<p><code>libpaf</code> comes with built-in support for tracing. The library supports writing traces to stderr in human-readable format, or direct them to LTTng. The former is always available, and the latter is available if the library is built with LTTng support.</p>
<p>To enable stderr-type tracing, set the <code>PAF_DEBUG</code> environment variable to "1", before starting the application.</p>
<p>To enabled LTTng tracing, enable the relevant libpaf LTTng tracepoints.</p>
<h1><a class="anchor" id="thread_safety"></a>
Multi-thread Safety</h1>
<p>All API calls are multi-thread (MT) safe when called on different context (for <a class="el" href="paf_8h.html" title="Core Pathfinder Client Library API.">paf.h</a> API calls) or service properties (for <a class="el" href="paf__props_8h.html" title="Pathfinder Service Properties API.">paf_props.h</a> API calls). Thus, one thread may safely call <a class="el" href="paf_8h.html#a0882224e814007bc8d60aa951e432df6">paf_publish()</a>, while another thread calls the same (or a different) paf_*() function, but on another context.</p>
<p>No API calls are MT safe when called on the same context or service properties. For that to work, external synchronization (e.g., a mutex lock) is required. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Tue Dec 17 2024 10:54:18 for libpaf by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
